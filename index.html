<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KAKO Live Login</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .container { max-width: 400px; margin: 50px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
    input, button { width: 100%; padding: 10px; margin: 8px 0; }
    .notification { background: #f8d7da; color: #721c24; padding: 8px; border-radius: 5px; margin: 10px 0; display: none; }
    .hidden { display: none; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; max-width: 300px; width: 100%; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Login</h2>
    <div class="notification" id="notification"></div>
    <form id="loginForm">
      <input type="text" id="idInput" placeholder="ID da conta" required />
      <input type="text" id="phoneInput" placeholder="Telefone (11 dígitos)" required />
      <button type="submit">Solicitar Código SMS</button>
    </form>
  </div>

  <!-- Modal do PIN -->
  <div id="pinModal" class="modal hidden">
    <div class="modal-content">
      <h3>Verificação SMS</h3>
      <p>Digite o código enviado para seu número.</p>
      <input type="text" id="pinInput" maxlength="6" placeholder="000000" />
      <button id="pinSubmit">Confirmar</button>
      <button onclick="pinModal.classList.add('hidden')">Cancelar</button>
    </div>
  </div>

  <script>
    const idInput = document.getElementById('idInput');
    const phoneInput = document.getElementById('phoneInput');
    const notification = document.getElementById('notification');
    const loginForm = document.getElementById('loginForm');
    const pinModal = document.getElementById('pinModal');
    const pinInput = document.getElementById('pinInput');
    const pinSubmit = document.getElementById('pinSubmit');

    let currentPhone = null;
    let currentId = null;

    function showNotification(msg) {
      notification.textContent = msg;
      notification.style.display = 'block';
      setTimeout(() => notification.style.display = 'none', 3000);
    }

    function startSmsCooldown() {
      console.log("Cooldown iniciado (simulação).");
    }

    function startPinCountdown() {
      console.log("Contagem regressiva PIN iniciada (simulação).");
    }

    async function handleFormSubmit(e) {
      e.preventDefault();

      const id = idInput.value.trim();
      const phone = phoneInput.value.trim();

      if (!id || !phone) {
        showNotification('Por favor, preencha todos os campos');
        return;
      }

      if (!/^\d{11}$/.test(phone)) {
        showNotification('Número de telefone inválido. Use 11 dígitos.');
        return;
      }

      currentPhone = '+55' + phone.replace(/\D/g, '');
      currentId = id;

      try {
        const response = await fetch('/api/v1/login/phone/check', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: currentPhone, scene: 1 })
        });

        const result = await response.json();
        console.log("DEBUG result:", result);

        if (result.code == 0) { // aceita número ou string
          pinModal.classList.remove('hidden');
          startSmsCooldown();
          startPinCountdown();
        } else {
          showNotification(result.msg || 'Erro ao verificar telefone');
        }
      } catch (error) {
        showNotification('Erro de conexão. Tente novamente.');
      }
    }

    async function handlePinSubmit() {
      const code = pinInput.value.trim();

      if (!/^\d{6}$/.test(code)) {
        showNotification('Código inválido. Deve ter 6 dígitos.');
        return;
      }

      try {
        const response = await fetch('/api/v1/login/phone/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            phone: currentPhone,
            password: currentId,
            code: code,
            scene: 0
          })
        });

        const result = await response.json();

        if (result.code == 0) {
          showNotification('Login realizado com sucesso!');
          pinModal.classList.add('hidden');
        } else {
          showNotification(result.msg || 'Falha ao verificar código');
        }
      } catch (error) {
        showNotification('Erro de conexão. Tente novamente.');
      }
    }

    loginForm.addEventListener('submit', handleFormSubmit);
    pinSubmit.addEventListener('click', handlePinSubmit);
  </script>
</body>
</html>
